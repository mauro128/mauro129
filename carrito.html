<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Carrito - Coffee House</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:"Poppins",sans-serif;background:#5d4037;color:#fff;min-height:100vh;margin:0;padding:20px;}
  h1{text-align:center;margin-bottom:20px;}
  table{width:100%;border-collapse:collapse;margin-bottom:20px;}
  th,td{padding:12px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.2);}
  th{background:rgba(0,0,0,0.2);}
  input.qty{width:50px;padding:4px;border-radius:4px;border:none;text-align:center;}
  .total{font-weight:700;font-size:1.2rem;text-align:right;margin-bottom:20px;}
  .btn{display:block;width:100%;padding:12px;background:#795548;color:#fff;border:none;border-radius:8px;font-size:1rem;cursor:pointer;transition:0.3s;margin-top:10px;}
  .btn:hover{background:#6d4c41;}
  .btn-eliminar{background:#b71c1c;color:#fff;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;}
  .btn-eliminar:hover{background:#c62828;}
</style>
</head>
<body>

<h1>Tu Carrito 游</h1>

<table id="carritoTable">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Precio ($)</th>
      <th>Cantidad</th>
      <th>Tiempo Estimado</th>
      <th>Acci칩n</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="total" id="total"></div>

<button class="btn" id="finalizar">Finalizar Pedido</button>

<script>
  // Obtener carrito desde localStorage
  let carrito = JSON.parse(localStorage.getItem('carrito')) || [];

  // Si no tiene tiempo, le asignamos uno por defecto
  carrito = carrito.map(item => ({...item, tiempo:item.tiempo||5, cantidad: item.cantidad||1}));

  const tbody = document.querySelector('#carritoTable tbody');

  function renderCarrito(){
    tbody.innerHTML = '';
    let total=0;
    let tiempoTotal=0;
    carrito.forEach((item,index)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${item.nombre}</td>
        <td>${item.precio}</td>
        <td><input type="number" class="qty" min="1" value="${item.cantidad}" data-index="${index}"></td>
        <td>${item.tiempo * item.cantidad} min</td>
        <td><button class="btn-eliminar" data-index="${index}">Eliminar</button></td>
      `;
      tbody.appendChild(tr);
      total += item.precio * item.cantidad;
      tiempoTotal += item.tiempo * item.cantidad;
    });
    document.getElementById('total').textContent=`Total: $${total} - Tiempo estimado: ${tiempoTotal} min`;
    attachEvents();
  }

  function attachEvents(){
    // Actualizar cantidad
    document.querySelectorAll('.qty').forEach(input=>{
      input.addEventListener('change', e=>{
        const index = e.target.dataset.index;
        let val = parseInt(e.target.value);
        if(val<1) val=1;
        carrito[index].cantidad=val;
        localStorage.setItem('carrito',JSON.stringify(carrito));
        renderCarrito();
      });
    });

    // Eliminar producto
    document.querySelectorAll('.btn-eliminar').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const index = btn.dataset.index;
        carrito.splice(index,1);
        localStorage.setItem('carrito',JSON.stringify(carrito));
        renderCarrito();
      });
    });
  }

  renderCarrito();

  document.getElementById('finalizar').addEventListener('click',()=>{
    // Calcular tiempo total antes de vaciar
    const tiempoTotal = carrito.reduce((sum,item)=>sum + item.tiempo*item.cantidad,0);

    localStorage.removeItem('carrito');

    function terminarPedido(){
      if(Notification.permission==='granted'){
        new Notification("El pedido est치 listo para retirar!");
      } else {
        alert("El pedido est치 listo para retirar!");
      }
      window.location.href='index.html';
    }

    if(Notification.permission!=='granted'){
      Notification.requestPermission().then(p=>{
        if(p==='granted'){
          setTimeout(terminarPedido, tiempoTotal*60000);
        } else {
          alert("Pedido enviado. Volviendo a la p치gina principal.");
          window.location.href='index.html';
        }
      });
    } else {
      setTimeout(terminarPedido, tiempoTotal*60000);
    }
  });
</script>

</body>
</html>
